use super::ast::{Field, Identifier, Import, Item, ItemType, Location, Primitive, Pointer, PointerModifier, Struct, Type};
use super::lexer;

grammar(file_id: usize);

extern {
    type Location = usize;
    type Error = ();

    enum lexer::Token {
        "{" => lexer::Token::LeftBracket,
        "}" => lexer::Token::RightBracket,
        ":" => lexer::Token::Colon,
        "," => lexer::Token::Comma,
        ";" => lexer::Token::Semicolon,
        "*" => lexer::Token::Asterisk,
        "primitive" => lexer::Token::Primitive(<Primitive>),
        "struct" => lexer::Token::Struct,
        "const" => lexer::Token::Const,
        "owned" => lexer::Token::Owned,
        "mut" => lexer::Token::Mut,
        "import" => lexer::Token::Import,
        "string" => lexer::Token::String(<String>),
        "identifier" => lexer::Token::Identifier(<String>),
        "comment" => lexer::Token::Comment(<String>),
        "doc-comment" => lexer::Token::DocComment(<String>),
    }
}

String: String =
    "string" => <>;

Comment: String =
    "comment" => <>;

DocComment: String =
    "doc-comment" => <>;    

Primitive: Primitive =
    "primitive" => <>;

IdentifierString: String =
    "identifier" => <>;

Identifier: Identifier =
    <l: @L> <identifier: IdentifierString> <r: @R> => Identifier { location: Location::new(file_id, l..r), identifier };

PointerModifier: PointerModifier = {
    "const" => PointerModifier::Const,
    "mut" => PointerModifier::Mut,
    "owned" => PointerModifier::Owned,
}

Pointer: Pointer =
    <l: @L> <modifier: PointerModifier> "*" <ty: Type> <r: @R> => Pointer { location: Location::new(file_id, l..r), modifier, ty: Box::new(ty) };

Type: Type = {
    <l: @L> <primitive: Primitive> <r: @R> => Type::Primitive { location: Location::new(file_id, l..r), primitive },
    <pointer: Pointer> => Type::Pointer(pointer),
    <identifier: Identifier> => Type::Identifier(identifier),
}

Field: Field =
    <docs: DocComment*> <name: Identifier> ":" <ty: Type> "," => Field { docs, name, ty };

StructContents: Option<Vec<Field>> = {
    "{" <fields: Field*> "}" => Some(fields),
    ";" => None,
}

Struct: Struct =
    <l: @L> "struct" <name: Identifier> <fields: StructContents> <r: @R> => Struct { location: Location::new(file_id, l..r), name, fields };

Import: Import =
    <l: @L> "import" <path: String> <r: @R> => Import { location: Location::new(file_id, l..r), path, resolved: None };

ItemType: ItemType = {
    <s: Struct> => ItemType::Struct(s),
    <i: Import> => ItemType::Import(i),
}

Item: Item =
    <docs: DocComment*> <item: ItemType> => Item { docs, item };

pub Program: Vec<Item> =
    <items: Item*> => <>;
